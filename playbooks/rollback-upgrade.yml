---
- hosts: webservers
  vars:
    # Rollback configuration - backup_timestamp should be passed as extra var
    wpcontainer: "{{ ovc_wp.wp.container }}"
    dbcontainer: "{{ ovc_wp.db.container }}"
    
  tasks:
    - name: Validate rollback parameters
      fail:
        msg: "backup_timestamp is required. Run with: -e backup_timestamp=TIMESTAMP"
      when: backup_timestamp is not defined
      
    - name: Check if backup containers exist
      shell: |
        echo "ğŸ” Checking for backup containers..."
        if docker images | grep -q "backup-wp-{{ backup_timestamp }}"; then
          echo "âœ… WordPress backup container found: backup-wp-{{ backup_timestamp }}"
        else
          echo "âŒ WordPress backup container not found: backup-wp-{{ backup_timestamp }}"
          exit 1
        fi
        
        if docker images | grep -q "backup-db-{{ backup_timestamp }}"; then
          echo "âœ… Database backup container found: backup-db-{{ backup_timestamp }}"
        else
          echo "âŒ Database backup container not found: backup-db-{{ backup_timestamp }}"
          exit 1
        fi
      register: backup_check
      
    - name: Stop current containers
      shell: |
        echo "ğŸ›‘ Stopping current containers..."
        docker stop {{ wpcontainer }} || true
        docker stop {{ dbcontainer }} || true
        
        # Remove current containers
        docker rm {{ wpcontainer }} || true
        docker rm {{ dbcontainer }} || true
        
        echo "âœ… Current containers stopped and removed"
        
    - name: Restore containers from backup images
      shell: |
        echo "ğŸ”„ Restoring containers from backup images..."
        
        # Recreate WordPress container from backup
        docker run -d \
          --name {{ wpcontainer }} \
          --restart=always \
          --link {{ dbcontainer }}:mysql \
          -v {{ wpcontainer }}:/var/www/html \
          -e VIRTUAL_HOST="{{ ovc_wp_hosts }}" \
          -e LETSENCRYPT_HOST="{{ ovc_wp_hosts }}" \
          backup-wp-{{ backup_timestamp }}
        
        # Recreate database container from backup  
        docker run -d \
          --name {{ dbcontainer }} \
          --restart=always \
          -v ovc-wp-db-data:/var/lib/mysql \
          backup-db-{{ backup_timestamp }}
          
        echo "âœ… Containers restored from backup images"
        
    - name: Wait for containers to start
      pause:
        seconds: 30
        
    - name: Restore database if SQL backup exists
      shell: |
        echo "ğŸ’¾ Checking for database backup..."
        if [ -f ~/upgrade-backups-{{ backup_timestamp }}/final-backup-{{ backup_timestamp }}.sql ]; then
          echo "ğŸ“¥ Restoring database from SQL backup..."
          cat ~/upgrade-backups-{{ backup_timestamp }}/final-backup-{{ backup_timestamp }}.sql | \
            docker exec -i {{ dbcontainer }} mysql -u{{ ovc_wp.db.user }} -p{{ ovc_wp.db.password }} {{ ovc_wp.db.name }}
          echo "âœ… Database restored from SQL backup"
        else
          echo "âš ï¸ No SQL backup found - using container state only"
        fi
      ignore_errors: yes
      
    - name: Test rollback functionality
      shell: |
        echo "ğŸ§ª Testing rollback functionality..."
        
        # Test database connection
        db_test=$(docker exec {{ wpcontainer }} wp db check --allow-root 2>/dev/null && echo "âœ… DB OK" || echo "âŒ DB Error")
        echo "Database: $db_test"
        
        # Check WordPress version
        wp_version=$(docker exec {{ wpcontainer }} wp core version --allow-root 2>/dev/null || echo "Unable to detect")
        echo "WordPress Version: $wp_version"
        
        # Check PHP version
        php_version=$(docker exec {{ wpcontainer }} php -v | head -1)
        echo "PHP Version: $php_version"
        
        # Test site response
        sleep 15
        response=$(curl -s -o /dev/null -w "%{http_code}" https://{{ ovc_wp_hosts }} || echo "000")
        echo "Site response: $response"
        
        if [ "$response" == "200" ] || [ "$response" == "301" ] || [ "$response" == "302" ]; then
          echo "âœ… Site is accessible after rollback"
        else
          echo "âŒ Site not accessible after rollback (HTTP $response)"
          exit 1
        fi
      register: rollback_test
      
    - name: Clean up upgrade artifacts
      shell: |
        echo "ğŸ§¹ Cleaning up upgrade artifacts..."
        
        # Remove any failed upgrade containers
        docker rm -f {{ wpcontainer }}-new {{ wpcontainer }}-old 2>/dev/null || true
        
        # List remaining backup images
        echo "Backup images available for cleanup:"
        docker images | grep "backup-.*-{{ backup_timestamp }}" || echo "None found"
        
        echo "âœ… Cleanup complete"
      ignore_errors: yes
      
    - name: Display rollback results
      debug:
        msg: |
          
          ğŸ”™ ROLLBACK COMPLETE!
          ====================
          
          {{ rollback_test.stdout }}
          
          ğŸ“Š ROLLBACK SUMMARY:
          --------------------
          âœ… WordPress container: Restored from backup-wp-{{ backup_timestamp }}
          âœ… Database container: Restored from backup-db-{{ backup_timestamp }}
          âœ… Site accessibility: Verified
          
          ğŸ§¹ CLEANUP OPTIONS:
          -------------------
          1. Keep backups for safety (recommended for 24-48 hours)
          2. Manual cleanup when satisfied:
             docker rmi backup-wp-{{ backup_timestamp }} backup-db-{{ backup_timestamp }}
             rm -rf ~/upgrade-backups-{{ backup_timestamp }}/
          
          ğŸ¯ Your site has been rolled back to the pre-upgrade state.
          
          ğŸ“ TROUBLESHOOTING UPGRADE:
          ---------------------------
          Before attempting upgrade again:
          1. Review the upgrade compatibility report
          2. Fix any identified plugin/theme issues
          3. Consider incremental approach (WordPress 6.3 â†’ 6.5 â†’ 6.8)
          4. Test in staging environment first

  vars_files:
    - ../play_vars/ovc-wp.yml 